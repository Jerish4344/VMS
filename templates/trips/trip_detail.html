{% extends 'base.html' %}
{% load static %}

{% block title %}Trip Details - {{ trip.vehicle.license_plate }} - Vehicle Management System{% endblock %}

{% block extra_css %}
<style>
  .route-map {
    background: linear-gradient(135deg, #f8f9fc 0%, #e3e6f0 100%);
    border-radius: 1rem;
    padding: 2rem;
    margin: 1.5rem 0;
    position: relative;
    overflow: hidden;
  }
  
  .route-map::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="%23e3e6f0" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>') repeat;
    opacity: 0.3;
    z-index: 1;
  }
  
  .route-content {
    position: relative;
    z-index: 2;
  }
  
  .location-marker {
    display: flex;
    align-items: center;
    padding: 1rem 1.5rem;
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    margin: 1rem 0;
    border-left: 4px solid;
  }
  
  .location-marker.origin {
    border-left-color: #1cc88a;
  }
  
  .location-marker.destination {
    border-left-color: #e74a3b;
  }
  
  .route-line {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 3rem;
    position: relative;
  }
  
  .route-line::before {
    content: '';
    position: absolute;
    width: 2px;
    height: 100%;
    background: linear-gradient(to bottom, #1cc88a, #e74a3b);
    left: 50%;
    transform: translateX(-50%);
  }
  
  .route-arrow {
    background: white;
    border-radius: 50%;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    color: #4e73df;
    font-size: 1.25rem;
    position: relative;
    z-index: 3;
  }
  
  .info-card {
    border: none;
    border-radius: 1rem;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    transition: all 0.3s;
  }
  
  .info-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.2);
  }
  
  .stat-item {
    text-align: center;
    padding: 1rem;
    border-right: 1px solid #e3e6f0;
  }
  
  .stat-item:last-child {
    border-right: none;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #4e73df;
  }
  
  .stat-label {
    font-size: 0.875rem;
    color: #858796;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .timeline {
    position: relative;
    padding-left: 2rem;
  }
  
  .timeline::before {
    content: '';
    position: absolute;
    left: 0.75rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e3e6f0;
  }
  
  .timeline-item {
    position: relative;
    margin-bottom: 2rem;
    padding-left: 2rem;
  }
  
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -0.5rem;
    top: 0.25rem;
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
    background: white;
    border: 3px solid #4e73df;
  }
  
  .timeline-item.completed::before {
    background: #1cc88a;
    border-color: #1cc88a;
  }
  
  .status-badge {
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    font-weight: 600;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
  }
  
  .status-ongoing {
    background: #1cc88a;
    color: white;
  }
  
  .status-completed {
    background: #36b9cc;
    color: white;
  }
  
  .status-cancelled {
    background: #e74a3b;
    color: white;
  }

  /* Google Maps Integration Styles */
  .map-container {
    height: 400px;
    border-radius: 0.75rem;
    overflow: hidden;
    border: 1px solid #e3e6f0;
    margin: 1rem 0;
    position: relative;
  }

  .trip-map {
    height: 100%;
    width: 100%;
  }

  .map-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    background-color: #f8f9fc;
    color: #858796;
    flex-direction: column;
  }

  .map-controls {
    background: white;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }

  .map-toggle-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #4e73df;
    background: white;
    color: #4e73df;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-right: 0.5rem;
  }

  .map-toggle-btn:hover {
    background: #4e73df;
    color: white;
  }

  .map-toggle-btn.active {
    background: #4e73df;
    color: white;
  }

  .distance-analysis {
    background: linear-gradient(135deg, #e8f4fd 0%, #bee5eb 100%);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin: 1rem 0;
    border: 1px solid #bee5eb;
  }

  .distance-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.5);
  }

  .distance-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }

  .distance-label {
    font-weight: 600;
    color: #495057;
  }

  .distance-value {
    font-weight: bold;
    font-size: 1.1rem;
  }

  .distance-good {
    color: #28a745;
  }

  .distance-warning {
    color: #ffc107;
  }

  .distance-error {
    color: #dc3545;
  }

  .efficiency-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .efficiency-excellent {
    background-color: #d4edda;
    color: #155724;
  }

  .efficiency-good {
    background-color: #d1ecf1;
    color: #0c5460;
  }

  .efficiency-warning {
    background-color: #fff3cd;
    color: #856404;
  }

  .efficiency-poor {
    background-color: #f8d7da;
    color: #721c24;
  }

  .live-tracking {
    background: linear-gradient(135deg, #1cc88a 0%, #17a673 100%);
    color: white;
    border-radius: 0.75rem;
    padding: 1rem;
    margin: 1rem 0;
  }

  .tracking-info {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .tracking-status {
    display: flex;
    align-items: center;
  }

  .tracking-indicator {
    width: 12px;
    height: 12px;
    background: #28a745;
    border-radius: 50%;
    margin-right: 0.5rem;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  .location-history {
    max-height: 300px;
    overflow-y: auto;
  }

  .location-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid #e3e6f0;
    transition: background-color 0.2s;
  }

  .location-item:hover {
    background-color: #f8f9fc;
  }

  .location-item:last-child {
    border-bottom: none;
  }

  .location-icon {
    width: 2rem;
    height: 2rem;
    background: #4e73df;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin-right: 1rem;
    flex-shrink: 0;
  }

  .location-details {
    flex-grow: 1;
  }

  .location-address {
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  .location-time {
    font-size: 0.875rem;
    color: #858796;
  }

  .route-insights {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    border: 1px solid #e3e6f0;
    margin-top: 1rem;
  }

  .insight-item {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: #f8f9fc;
    border-radius: 0.5rem;
  }

  .insight-item:last-child {
    margin-bottom: 0;
  }

  .insight-icon {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    flex-shrink: 0;
  }

  .insight-icon.info {
    background: #d1ecf1;
    color: #0c5460;
  }

  .insight-icon.warning {
    background: #fff3cd;
    color: #856404;
  }

  .insight-icon.success {
    background: #d4edda;
    color: #155724;
  }

  .mini-map-container {
    height: 200px;
    border-radius: 0.5rem;
    overflow: hidden;
    border: 1px solid #e3e6f0;
    margin: 0.5rem 0;
  }

  .weather-info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 0.75rem;
    padding: 1rem;
    margin: 1rem 0;
    text-align: center;
  }

  .fuel-estimate {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border-radius: 0.75rem;
    padding: 1rem;
    margin: 1rem 0;
    text-align: center;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Page Header -->
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'trip_list' %}">Trips</a></li>
          <li class="breadcrumb-item active">Trip #{{ trip.id }}</li>
        </ol>
      </nav>
      <h1 class="h3 mb-0 text-gray-800">Trip Details</h1>
    </div>
    <div>
      {% if trip.status == 'ongoing' %}
        {% if user == trip.driver or user.user_type == 'admin' or user.user_type == 'manager' or user.user_type == 'vehicle_manager' %}
        <a href="{% url 'end_trip' trip.pk %}" class="btn btn-success">
          <i class="fas fa-stop me-1"></i>End Trip
        </a>
        <a href="{% url 'track_trip' trip.pk %}" class="btn btn-info">
          <i class="fas fa-map me-1"></i>Track Trip
        </a>
        {% endif %}
      {% endif %}
      {% if user.user_type == 'admin' or user.user_type == 'manager' %}
      <a href="{% url 'trip_edit' trip.pk %}" class="btn btn-warning">
        <i class="fas fa-edit me-1"></i>Edit Trip
      </a>
      {% endif %}
      <a href="{% url 'trip_list' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i>Back to List
      </a>
    </div>
  </div>

  <div class="row">
    <!-- Main Trip Information -->
    <div class="col-lg-8">
      <!-- Live Tracking for Ongoing Trips -->
      {% if trip.status == 'ongoing' %}
      <div class="live-tracking">
        <div class="tracking-info">
          <div class="tracking-status">
            <div class="tracking-indicator"></div>
            <div>
              <h6 class="mb-0">Live Tracking Active</h6>
              <small>Trip in progress - Location updating every 30 seconds</small>
            </div>
          </div>
          <div>
            <button class="btn btn-light btn-sm" onclick="refreshLocation()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Route Map -->
      <div class="card info-card mb-4">
        <div class="card-header bg-primary text-white">
          <h6 class="m-0 font-weight-bold">
            <i class="fas fa-route me-2"></i>Route Map & Analysis
          </h6>
        </div>
        <div class="card-body">
          <!-- Map Controls -->
          <div class="map-controls">
            <button class="map-toggle-btn active" onclick="showRouteMap()" id="routeBtn">
              <i class="fas fa-route me-1"></i>Route View
            </button>
            {% if trip.status == 'ongoing' %}
            <button class="map-toggle-btn" onclick="showLiveMap()" id="liveBtn">
              <i class="fas fa-map-marker-alt me-1"></i>Live Tracking
            </button>
            {% endif %}
            <button class="map-toggle-btn" onclick="showSatelliteMap()" id="satelliteBtn">
              <i class="fas fa-satellite me-1"></i>Satellite
            </button>
            <button class="map-toggle-btn" onclick="showTrafficMap()" id="trafficBtn">
              <i class="fas fa-traffic-light me-1"></i>Traffic
            </button>
          </div>

          <!-- Map Container -->
          <div class="map-container">
            <div class="trip-map" id="tripMap">
              <div class="map-loading">
                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                <div>Loading route map...</div>
              </div>
            </div>
          </div>

          <!-- Distance Analysis -->
          <div class="distance-analysis" id="distanceAnalysis" style="display: none;">
            <h6 class="mb-3">
              <i class="fas fa-chart-line me-2"></i>Distance Analysis
            </h6>
            
            <div class="distance-row">
              <span class="distance-label">Google Maps Distance:</span>
              <span class="distance-value" id="mapDistance">Calculating...</span>
            </div>
            
            {% if trip.distance_traveled > 0 %}
            <div class="distance-row">
              <span class="distance-label">Odometer Distance:</span>
              <span class="distance-value">{{ trip.distance_traveled }} km</span>
            </div>
            
            <div class="distance-row">
              <span class="distance-label">Difference:</span>
              <span class="distance-value" id="distanceDifference">Calculating...</span>
            </div>
            
            <div class="distance-row">
              <span class="distance-label">Route Efficiency:</span>
              <span id="routeEfficiency">Analyzing...</span>
            </div>
            {% endif %}
            
            <div class="distance-row">
              <span class="distance-label">Estimated Travel Time:</span>
              <span class="distance-value" id="estimatedTime">Calculating...</span>
            </div>
          </div>

          <!-- Route Insights -->
          <div class="route-insights" id="routeInsights" style="display: none;">
            <h6 class="mb-3">
              <i class="fas fa-lightbulb me-2"></i>Route Insights
            </h6>
            <div id="insightsList">
              <!-- Insights will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Traditional Route Information -->
      <div class="card info-card mb-4">
        <div class="card-header bg-success text-white">
          <h6 class="m-0 font-weight-bold">
            <i class="fas fa-map-signs me-2"></i>Route Information
          </h6>
        </div>
        <div class="card-body">
          <div class="route-map">
            <div class="route-content">
              <!-- Origin -->
              <div class="location-marker origin">
                <div class="me-3">
                  <i class="fas fa-map-marker-alt fa-2x text-success"></i>
                </div>
                <div>
                  <h6 class="mb-1 text-success">Starting Point</h6>
                  <p class="mb-0 font-weight-bold">{{ trip.origin }}</p>
                  <small class="text-muted">{{ trip.start_time|date:"M d, Y H:i" }}</small>
                </div>
              </div>

              <!-- Route Line -->
              <div class="route-line">
                <div class="route-arrow">
                  <i class="fas fa-arrow-down"></i>
                </div>
              </div>

              <!-- Destination -->
              <div class="location-marker destination">
                <div class="me-3">
                  <i class="fas fa-map-marker-alt fa-2x text-danger"></i>
                </div>
                <div>
                  <h6 class="mb-1 text-danger">Destination</h6>
                  <p class="mb-0 font-weight-bold">{{ trip.destination }}</p>
                  {% if trip.end_time %}
                  <small class="text-muted">{{ trip.end_time|date:"M d, Y H:i" }}</small>
                  {% else %}
                  <small class="text-muted">In progress...</small>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced Trip Statistics -->
      <div class="card info-card mb-4">
        <div class="card-header bg-info text-white">
          <h6 class="m-0 font-weight-bold">
            <i class="fas fa-chart-line me-2"></i>Trip Statistics
          </h6>
        </div>
        <div class="card-body p-0">
          <div class="row no-gutters">
            <div class="col-md-3">
              <div class="stat-item">
                <div class="stat-value">
                  {% if trip.distance_traveled > 0 %}
                    {{ trip.distance_traveled }}
                  {% else %}
                    --
                  {% endif %}
                </div>
                <div class="stat-label">Distance (km)</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-item">
                <div class="stat-value">
                  {% if trip.duration %}
                    {{ trip.duration }}
                  {% else %}
                    <span id="liveDuration">In Progress</span>
                  {% endif %}
                </div>
                <div class="stat-label">Duration</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-item">
                <div class="stat-value">{{ trip.start_odometer }}</div>
                <div class="stat-label">Start Odometer</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-item">
                <div class="stat-value">
                  {% if trip.end_odometer %}
                    {{ trip.end_odometer }}
                  {% else %}
                    --
                  {% endif %}
                </div>
                <div class="stat-label">End Odometer</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Fuel & Cost Estimates -->
      <div class="row">
        <div class="col-md-6">
          <div class="fuel-estimate">
            <h6 class="mb-2">
              <i class="fas fa-gas-pump me-2"></i>Fuel Estimate
            </h6>
            <div class="h4 mb-1" id="fuelEstimate">Calculating...</div>
            <small>Based on vehicle efficiency</small>
          </div>
        </div>
        <div class="col-md-6">
          <div class="weather-info">
            <h6 class="mb-2">
              <i class="fas fa-cloud-sun me-2"></i>Weather Impact
            </h6>
            <div class="h6 mb-1" id="weatherImpact">Checking...</div>
            <small>Route conditions</small>
          </div>
        </div>
      </div>

      <!-- Trip Timeline -->
      <div class="card info-card mb-4">
        <div class="card-header bg-warning text-white">
          <h6 class="m-0 font-weight-bold">
            <i class="fas fa-history me-2"></i>Trip Timeline
          </h6>
        </div>
        <div class="card-body">
          <div class="timeline">
            <div class="timeline-item completed">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">Trip Started</h6>
                  <p class="mb-1">Started journey from {{ trip.origin }}</p>
                  <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    {{ trip.start_time|date:"M d, Y H:i A" }}
                  </small>
                </div>
                <span class="badge bg-success">
                  <i class="fas fa-check me-1"></i>Completed
                </span>
              </div>
            </div>

            {% if trip.end_time %}
            <div class="timeline-item completed">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">Trip Completed</h6>
                  <p class="mb-1">Arrived at {{ trip.destination }}</p>
                  <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    {{ trip.end_time|date:"M d, Y H:i A" }}
                  </small>
                </div>
                <span class="badge bg-success">
                  <i class="fas fa-check me-1"></i>Completed
                </span>
              </div>
            </div>
            {% else %}
            <div class="timeline-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">En Route</h6>
                  <p class="mb-1">Traveling to {{ trip.destination }}</p>
                  <small class="text-muted">
                    <i class="fas fa-spinner fa-spin me-1"></i>
                    <span id="currentLocation">In progress...</span>
                  </small>
                </div>
                <span class="badge bg-warning">
                  <i class="fas fa-clock me-1"></i>Ongoing
                </span>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Notes Section -->
      {% if trip.notes %}
      <div class="card info-card mb-4">
        <div class="card-header bg-secondary text-white">
          <h6 class="m-0 font-weight-bold">
            <i class="fas fa-sticky-note me-2"></i>Trip Notes
          </h6>
        </div>
        <div class="card-body">
          <p class="mb-0">{{ trip.notes|linebreaks }}</p>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Sidebar Information -->
    <div class="col-lg-4">
      <!-- Trip Status -->
      <div class="card info-card mb-4">
        <div class="card-body text-center">
          <h6 class="card-title">Trip Status</h6>
          <span class="status-badge status-{{ trip.status }}">
            {% if trip.status == 'ongoing' %}
              <i class="fas fa-play me-2"></i>Ongoing
            {% elif trip.status == 'completed' %}
              <i class="fas fa-check me-2"></i>Completed
            {% else %}
              <i class="fas fa-times me-2"></i>Cancelled
            {% endif %}
          </span>
          {% if trip.status == 'ongoing' %}
          <div class="mt-2">
            <small class="text-muted">Live updates every 30 seconds</small>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Vehicle Information -->
      <div class="card info-card mb-4">
        <div class="card-header">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-car me-2"></i>Vehicle Details
          </h6>
        </div>
        <div class="card-body">
          {% if trip.vehicle.image %}
          <img src="{{ trip.vehicle.image.url }}" class="img-fluid rounded mb-3" alt="{{ trip.vehicle.license_plate }}">
          {% endif %}
          
          <div class="mb-2">
            <strong>Name:</strong><br>
            {{ trip.driver.get_full_name }}
          </div>
          
          <div class="mb-2">
            <strong>Email:</strong><br>
            {{ trip.driver.email }}
          </div>
          
          {% if trip.driver.license_number %}
          <div class="mb-2">
            <strong>License Number:</strong><br>
            {{ trip.driver.license_number }}
          </div>
          {% endif %}
          
          {% if trip.driver.phone %}
          <div class="mb-0">
            <strong>Phone:</strong><br>
            {{ trip.driver.phone }}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Trip Purpose -->
      <div class="card info-card mb-4">
        <div class="card-header">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-tag me-2"></i>Trip Purpose
          </h6>
        </div>
        <div class="card-body">
          <p class="mb-0">{{ trip.purpose }}</p>
        </div>
      </div>

      <!-- Quick Actions -->
      {% if trip.status == 'ongoing' %}
        {% if user == trip.driver or user.user_type == 'admin' or user.user_type == 'manager' or user.user_type == 'vehicle_manager' %}
        <div class="card info-card mb-4">
          <div class="card-header">
            <h6 class="m-0 font-weight-bold text-primary">
              <i class="fas fa-tools me-2"></i>Quick Actions
            </h6>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <a href="{% url 'end_trip' trip.pk %}" class="btn btn-success">
                <i class="fas fa-stop me-2"></i>End Trip
              </a>
              <a href="{% url 'track_trip' trip.pk %}" class="btn btn-info">
                <i class="fas fa-map me-2"></i>Live Tracking
              </a>
              <button class="btn btn-warning" onclick="exportTripReport()">
                <i class="fas fa-download me-2"></i>Export Report
              </button>
            </div>
          </div>
        </div>
        {% endif %}
      {% endif %}

      <!-- Location Tracking -->
      <div class="card info-card mb-4">
        <div class="card-header">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-map-marked-alt me-2"></i>Location History
          </h6>
        </div>
        <div class="card-body p-0">
          <div class="location-history" id="locationHistory">
            {% if locations %}
              {% for location in locations|slice:":10" %}
              <div class="location-item">
                <div class="location-icon">
                  <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="location-details">
                  <div class="location-address">{{ location.address|default:"Unknown Location" }}</div>
                  <div class="location-time">{{ location.timestamp|date:"M d, H:i" }}</div>
                </div>
              </div>
              {% empty %}
              <div class="text-center p-3 text-muted">
                <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                <div>No location data available</div>
              </div>
              {% endfor %}
            {% else %}
            <div class="text-center p-3 text-muted">
              <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
              <div>No location data available</div>
              {% if trip.status == 'ongoing' %}
              <small>Location tracking will appear here</small>
              {% endif %}
            </div>
            {% endif %}
          </div>
          {% if trip.status == 'ongoing' %}
          <div class="card-footer bg-light">
            <small class="text-muted">
              <i class="fas fa-sync-alt fa-spin"></i>
              Auto-updating every 30 seconds
            </small>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Weather Information -->
      <div class="card info-card mb-4">
        <div class="card-header">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-cloud-sun me-2"></i>Weather Conditions
          </h6>
        </div>
        <div class="card-body text-center">
          <div id="weatherInfo">
            <i class="fas fa-spinner fa-spin"></i>
            <div>Loading weather data...</div>
          </div>
        </div>
      </div>

      <!-- Trip Analytics -->
      {% if trip.status == 'completed' %}
      <div class="card info-card mb-4">
        <div class="card-header">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-analytics me-2"></i>Trip Analytics
          </h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <small class="text-muted">Average Speed</small>
            <div class="h6 mb-0" id="averageSpeed">Calculating...</div>
          </div>
          <div class="mb-3">
            <small class="text-muted">Fuel Consumption</small>
            <div class="h6 mb-0" id="fuelConsumption">Calculating...</div>
          </div>
          <div class="mb-3">
            <small class="text-muted">Cost Estimate</small>
            <div class="h6 mb-0" id="costEstimate">Calculating...</div>
          </div>
          <div class="mb-0">
            <small class="text-muted">Efficiency Rating</small>
            <div id="efficiencyRating">Analyzing...</div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Mini Route Map -->
      <div class="card info-card mb-4">
        <div class="card-header">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-route me-2"></i>Quick Route View
          </h6>
        </div>
        <div class="card-body p-0">
          <div class="mini-map-container">
            <div class="trip-map" id="miniMap">
              <div class="map-loading">
                <i class="fas fa-map"></i>
                <div>Mini route map</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Google Maps API -->
<script async defer 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDMAkESwj75ZhnMIlLK25zHiM1oAUPZtbo&libraries=places,geometry&callback=initTripDetailMaps">
</script>

<script>
  // Global variables
  let map, miniMap;
  let directionsService, directionsRenderer, miniDirectionsRenderer;
  let currentLocationMarker;
  let routeData = {};
  
  // Trip data from Django
  const tripData = {
    id: {{ trip.id }},
    origin: "{{ trip.origin|escapejs }}",
    destination: "{{ trip.destination|escapejs }}",
    status: "{{ trip.status }}",
    startTime: "{{ trip.start_time|date:'c' }}",
    endTime: {% if trip.end_time %}"{{ trip.end_time|date:'c' }}"{% else %}null{% endif %},
    odometerDistance: {{ trip.distance_traveled|default:0 }},
    startOdometer: {{ trip.start_odometer|default:0 }},
    endOdometer: {% if trip.end_odometer %}{{ trip.end_odometer }}{% else %}null{% endif %},
    vehicleEfficiency: {% if trip.vehicle.fuel_efficiency %}{{ trip.vehicle.fuel_efficiency }}{% else %}15{% endif %}
  };

  // Initialize Google Maps
  function initTripDetailMaps() {
    directionsService = new google.maps.DirectionsService();
    
    // Initialize main map
    initializeMainMap();
    
    // Initialize mini map
    initializeMiniMap();
    
    // Load route data
    calculateRouteData();
    
    // Start live updates for ongoing trips
    if (tripData.status === 'ongoing') {
      startLiveUpdates();
    }
    
    // Load additional data
    loadWeatherData();
    calculateTripAnalytics();
  }

  // Initialize main map
  function initializeMainMap() {
    const mapElement = document.getElementById('tripMap');
    
    map = new google.maps.Map(mapElement, {
      zoom: 13,
      center: { lat: 12.9716, lng: 77.5946 },
      mapTypeId: 'roadmap',
      styles: [
        {
          featureType: 'poi',
          elementType: 'labels',
          stylers: [{ visibility: 'off' }]
        }
      ]
    });

    directionsRenderer = new google.maps.DirectionsRenderer({
      draggable: false,
      suppressMarkers: false,
      panel: null
    });
    
    directionsRenderer.setMap(map);
  }

  // Initialize mini map
  function initializeMiniMap() {
    const miniMapElement = document.getElementById('miniMap');
    
    miniMap = new google.maps.Map(miniMapElement, {
      zoom: 10,
      center: { lat: 12.9716, lng: 77.5946 },
      mapTypeId: 'roadmap',
      disableDefaultUI: true,
      zoomControl: false,
      styles: [
        {
          featureType: 'poi',
          elementType: 'labels',
          stylers: [{ visibility: 'off' }]
        }
      ]
    });

    miniDirectionsRenderer = new google.maps.DirectionsRenderer({
      draggable: false,
      suppressMarkers: false,
      panel: null
    });
    
    miniDirectionsRenderer.setMap(miniMap);
  }

  // Calculate route data
  function calculateRouteData() {
    if (!tripData.origin || !tripData.destination) return;

    const request = {
      origin: tripData.origin,
      destination: tripData.destination,
      travelMode: google.maps.TravelMode.DRIVING,
      unitSystem: google.maps.UnitSystem.METRIC,
      avoidHighways: false,
      avoidTolls: false
    };

    directionsService.route(request, function(result, status) {
      if (status === 'OK') {
        // Display route on both maps
        directionsRenderer.setDirections(result);
        miniDirectionsRenderer.setDirections(result);
        
        // Calculate route statistics
        const route = result.routes[0];
        let totalDistance = 0;
        let totalDuration = 0;
        
        route.legs.forEach(leg => {
          totalDistance += leg.distance.value;
          totalDuration += leg.duration.value;
        });
        
        // Store route data
        routeData.mapDistance = (totalDistance / 1000).toFixed(2);
        routeData.estimatedDuration = Math.round(totalDuration / 60);
        
        // Update UI
        updateDistanceAnalysis();
        updateRouteInsights();
        
      } else {
        console.error('Could not calculate route:', status);
        document.getElementById('tripMap').innerHTML = 
          '<div class="map-loading"><i class="fas fa-exclamation-triangle text-warning"></i><div>Route not available</div></div>';
      }
    });
  }

  // Update distance analysis
  function updateDistanceAnalysis() {
    const analysisDiv = document.getElementById('distanceAnalysis');
    analysisDiv.style.display = 'block';
    
    // Update map distance
    document.getElementById('mapDistance').textContent = routeData.mapDistance + ' km';
    
    // Update estimated time
    document.getElementById('estimatedTime').textContent = routeData.estimatedDuration + ' minutes';
    
    // Calculate difference if odometer data exists
    if (tripData.odometerDistance > 0) {
      const difference = Math.abs(routeData.mapDistance - tripData.odometerDistance).toFixed(2);
      const diffElement = document.getElementById('distanceDifference');
      
      diffElement.textContent = difference + ' km';
      
      // Color code the difference
      if (difference <= 2) {
        diffElement.className = 'distance-value distance-good';
      } else if (difference <= 5) {
        diffElement.className = 'distance-value distance-warning';
      } else {
        diffElement.className = 'distance-value distance-error';
      }
      
      // Update efficiency rating
      updateEfficiencyRating(difference);
    }
  }

  // Update efficiency rating
  function updateEfficiencyRating(difference) {
    const efficiencyElement = document.getElementById('routeEfficiency');
    let rating = '';
    
    if (difference <= 1) {
      rating = '<span class="efficiency-badge efficiency-excellent"><i class="fas fa-star"></i> Excellent</span>';
    } else if (difference <= 3) {
      rating = '<span class="efficiency-badge efficiency-good"><i class="fas fa-thumbs-up"></i> Good</span>';
    } else if (difference <= 7) {
      rating = '<span class="efficiency-badge efficiency-warning"><i class="fas fa-exclamation-triangle"></i> Moderate</span>';
    } else {
      rating = '<span class="efficiency-badge efficiency-poor"><i class="fas fa-times"></i> Poor</span>';
    }
    
    efficiencyElement.innerHTML = rating;
  }

  // Update route insights
  function updateRouteInsights() {
    const insightsDiv = document.getElementById('routeInsights');
    const insightsList = document.getElementById('insightsList');
    
    let insights = [];
    
    // Distance analysis insight
    if (tripData.odometerDistance > 0) {
      const difference = Math.abs(routeData.mapDistance - tripData.odometerDistance);
      if (difference <= 2) {
        insights.push({
          type: 'success',
          icon: 'check-circle',
          message: 'Route efficiency is excellent. Driver followed optimal path.'
        });
      } else if (difference > 5) {
        insights.push({
          type: 'warning',
          icon: 'exclamation-triangle',
          message: `Route deviated by ${difference.toFixed(1)} km from optimal path.`
        });
      }
    }
    
    // Duration analysis
    if (tripData.endTime) {
      const actualDuration = (new Date(tripData.endTime) - new Date(tripData.startTime)) / (1000 * 60);
      const timeDifference = actualDuration - routeData.estimatedDuration;
      
      if (timeDifference > 30) {
        insights.push({
          type: 'info',
          icon: 'clock',
          message: `Trip took ${Math.round(timeDifference)} minutes longer than estimated.`
        });
      }
    }
    
    // Fuel efficiency insight
    if (tripData.odometerDistance > 0) {
      const estimatedFuel = (tripData.odometerDistance / tripData.vehicleEfficiency).toFixed(1);
      insights.push({
        type: 'info',
        icon: 'gas-pump',
        message: `Estimated fuel consumption: ${estimatedFuel} liters.`
      });
    }
    
    // Render insights
    if (insights.length > 0) {
      insightsList.innerHTML = insights.map(insight => `
        <div class="insight-item">
          <div class="insight-icon ${insight.type}">
            <i class="fas fa-${insight.icon}"></i>
          </div>
          <div>${insight.message}</div>
        </div>
      `).join('');
      
      insightsDiv.style.display = 'block';
    }
  }

  // Map control functions
  function showRouteMap() {
    map.setMapTypeId('roadmap');
    updateActiveButton('routeBtn');
  }

  function showLiveMap() {
    map.setMapTypeId('roadmap');
    // Add live tracking functionality here
    updateActiveButton('liveBtn');
    
    if (tripData.status === 'ongoing') {
      // Add current location marker if available
      getCurrentLocation();
    }
  }

  function showSatelliteMap() {
    map.setMapTypeId('satellite');
    updateActiveButton('satelliteBtn');
  }

  function showTrafficMap() {
    map.setMapTypeId('roadmap');
    
    const trafficLayer = new google.maps.TrafficLayer();
    trafficLayer.setMap(map);
    
    updateActiveButton('trafficBtn');
  }

  function updateActiveButton(activeId) {
    const buttons = document.querySelectorAll('.map-toggle-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    document.getElementById(activeId).classList.add('active');
  }

  // Live updates for ongoing trips
  function startLiveUpdates() {
    // Update live duration
    updateLiveDuration();
    setInterval(updateLiveDuration, 1000);
    
    // Refresh location data
    setInterval(refreshLocation, 30000);
  }

  function updateLiveDuration() {
    if (tripData.status !== 'ongoing') return;
    
    const startTime = new Date(tripData.startTime);
    const now = new Date();
    const duration = Math.floor((now - startTime) / 1000);
    
    const hours = Math.floor(duration / 3600);
    const minutes = Math.floor((duration % 3600) / 60);
    const seconds = duration % 60;
    
    const durationElement = document.getElementById('liveDuration');
    if (durationElement) {
      durationElement.textContent = `${hours}h ${minutes}m ${seconds}s`;
    }
  }

  function refreshLocation() {
    // Implement AJAX call to get current location
    // This would call your backend API to get latest location
    console.log('Refreshing location data...');
    
    // Example AJAX call (implement based on your backend)
    /*
    fetch(`/api/trips/${tripData.id}/current-location/`)
      .then(response => response.json())
      .then(data => {
        updateCurrentLocationMarker(data.latitude, data.longitude);
        updateLocationHistory(data);
      })
      .catch(error => console.error('Error fetching location:', error));
    */
  }

  function getCurrentLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        const currentPos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        
        updateCurrentLocationMarker(currentPos.lat, currentPos.lng);
      });
    }
  }

  function updateCurrentLocationMarker(lat, lng) {
    if (currentLocationMarker) {
      currentLocationMarker.setMap(null);
    }
    
    currentLocationMarker = new google.maps.Marker({
      position: { lat: lat, lng: lng },
      map: map,
      title: 'Current Location',
      icon: {
        url: 'data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FF0000"><circle cx="12" cy="12" r="8"/></svg>',
        scaledSize: new google.maps.Size(20, 20)
      }
    });
    
    // Update current location text
    const currentLocationElement = document.getElementById('currentLocation');
    if (currentLocationElement) {
      currentLocationElement.textContent = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
    }
  }

  // Load weather data
  function loadWeatherData() {
    // Implement weather API call
    // Example with OpenWeatherMap API
    /*
    const apiKey = 'YOUR_WEATHER_API_KEY';
    const url = `https://api.openweathermap.org/data/2.5/weather?q=${tripData.origin}&appid=${apiKey}&units=metric`;
    
    fetch(url)
      .then(response => response.json())
      .then(data => {
        const weatherInfo = document.getElementById('weatherInfo');
        weatherInfo.innerHTML = `
          <div class="h5">${data.weather[0].main}</div>
          <div>${Math.round(data.main.temp)}°C</div>
        `;
        
        const weatherImpact = document.getElementById('weatherImpact');
        if (data.weather[0].main.includes('Rain')) {
          weatherImpact.innerHTML = 'Rainy conditions<br><small>+10% travel time</small>';
        } else {
          weatherImpact.innerHTML = 'Clear conditions<br><small>Normal travel time</small>';
        }
      })
      .catch(error => {
        document.getElementById('weatherInfo').innerHTML = '<div class="text-muted">Weather data unavailable</div>';
      });
    */
    
    // Placeholder implementation
    document.getElementById('weatherInfo').innerHTML = '<div class="text-muted">Weather data unavailable</div>';
    document.getElementById('weatherImpact').innerHTML = 'Normal conditions';
  }

  // Calculate trip analytics
  function calculateTripAnalytics() {
    if (tripData.status === 'completed' && routeData.mapDistance) {
      // Update fuel estimate
      const fuelEstimate = (routeData.mapDistance / tripData.vehicleEfficiency).toFixed(1);
      document.getElementById('fuelEstimate').textContent = fuelEstimate + ' L';
      
      // Calculate average speed
      if (tripData.endTime) {
        const duration = (new Date(tripData.endTime) - new Date(tripData.startTime)) / (1000 * 60 * 60);
        const avgSpeed = (tripData.odometerDistance / duration).toFixed(1);
        
        const avgSpeedElement = document.getElementById('averageSpeed');
        if (avgSpeedElement) {
          avgSpeedElement.textContent = avgSpeed + ' km/h';
        }
        
        // Calculate fuel consumption
        const fuelConsumptionElement = document.getElementById('fuelConsumption');
        if (fuelConsumptionElement) {
          fuelConsumptionElement.textContent = fuelEstimate + ' L';
        }
        
        // Calculate cost estimate (assuming 100 rupees per liter)
        const costEstimateElement = document.getElementById('costEstimate');
        if (costEstimateElement) {
          const cost = (parseFloat(fuelEstimate) * 100).toFixed(0);
          costEstimateElement.textContent = '₹' + cost;
        }
        
        // Efficiency rating
        const efficiencyElement = document.getElementById('efficiencyRating');
        if (efficiencyElement) {
          const efficiency = tripData.vehicleEfficiency / (parseFloat(fuelEstimate) / routeData.mapDistance * 100);
          let rating = '';
          
          if (efficiency >= 0.9) {
            rating = '<span class="efficiency-badge efficiency-excellent">Excellent</span>';
          } else if (efficiency >= 0.7) {
            rating = '<span class="efficiency-badge efficiency-good">Good</span>';
          } else if (efficiency >= 0.5) {
            rating = '<span class="efficiency-badge efficiency-warning">Average</span>';
          } else {
            rating = '<span class="efficiency-badge efficiency-poor">Poor</span>';
          }
          
          efficiencyElement.innerHTML = rating;
        }
      }
    } else {
      // For ongoing trips, show estimates
      if (routeData.mapDistance) {
        const fuelEstimate = (routeData.mapDistance / tripData.vehicleEfficiency).toFixed(1);
        document.getElementById('fuelEstimate').textContent = '~' + fuelEstimate + ' L';
      }
    }
  }

  // Export trip report
  function exportTripReport() {
    const params = new URLSearchParams({
      trip_id: tripData.id,
      include_map: 'true',
      include_analytics: 'true'
    });
    
    window.open(`/trips/export-report/?${params.toString()}`, '_blank');
  }

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh for ongoing trips
    if (tripData.status === 'ongoing') {
      setInterval(function() {
        // Refresh trip data via AJAX
        refreshTripData();
      }, 30000);
    }
  });

  function refreshTripData() {
    // Implement AJAX call to refresh trip data
    // This would update odometer readings, location, etc.
    console.log('Refreshing trip data...');
  }
</script>
{% endblock %}